name: CI/CD

on:
  push:

jobs:
  deploy:
    name: Deploy to Raspberry Pi
    environment: raspberry
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: SSH & Test Connection
        uses: appleboy/ssh-action@v1.0.0
        env:
          PROJECT_DIR: ${{ secrets.RPI_TOOLS_DIR }}
        with:
          host: ${{ secrets.SERVER_HOST }}
          port: ${{ secrets.SERVER_PORT }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          envs: PROJECT_DIR
          script: |
            # Load NVM properly
            export NVM_DIR="$HOME/.nvm"
            [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
            [ -s "$NVM_DIR/bash_completion" ] && \. "$NVM_DIR/bash_completion"
            
            # Source the profile to load environment variables
            source ~/.bashrc || source ~/.profile || true

            echo "🔗 SSH Connection successful!"
            echo "📍 Current directory: $(pwd)"
            echo "👤 Current user: $(whoami)"
            echo "🏠 Home directory: $HOME"
            echo "📁 Project directory from secret: $PROJECT_DIR"
            echo "💻 System info: $(uname -a)"
            echo "🛤️ PATH: $PATH"
            
            # Now check Node.js and npm after loading NVM
            echo "📦 Node.js version: $(node --version 2>/dev/null || echo 'Node.js not installed')"
            echo "📦 npm version: $(npm --version 2>/dev/null || echo 'npm not installed')"
            echo "📦 nvm version: $(nvm --version 2>/dev/null || echo 'nvm not installed')"
            
            # Show which node and npm are being used
            echo "🔍 Node.js location: $(which node 2>/dev/null || echo 'node not found in PATH')"
            echo "🔍 npm location: $(which npm 2>/dev/null || echo 'npm not found in PATH')"
            
            # Try to find npm in the same directory as node
            NODE_PATH=$(which node 2>/dev/null)
            if [ -n "$NODE_PATH" ]; then
              NPM_PATH="$(dirname $NODE_PATH)/npm"
              echo "🔍 Expected npm path: $NPM_PATH"
              if [ -f "$NPM_PATH" ]; then
                echo "✅ npm found at expected location"
                echo "📦 npm version (direct): $($NPM_PATH --version)"
              else
                echo "❌ npm not found at expected location"
                echo "📁 Contents of node bin directory:"
                ls -la "$(dirname $NODE_PATH)/" | head -10
              fi
            fi