name: CI/CD

on:
  push:

jobs:
  deploy:
    name: Deploy to Raspberry Pi
    environment: raspberry
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: SSH & Deploy to Pi
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SERVER_HOST }}
          port: ${{ secrets.SERVER_PORT }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          envs: PROJECT_DIR
        env:
          PROJECT_DIR: ${{ secrets.RPI_TOOLS_DIR }}
        script: |
          set -e

          # Check if Node.js is installed, if not install it
          if ! command -v node &> /dev/null; then
            echo "ğŸ“¥ Installing Node.js..."
            curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash -
            sudo apt-get install -y nodejs
          else
            echo "âœ… Node.js is already installed: $(node --version)"
          fi

          # Verify npm is available
          npm --version

          echo "ğŸ“ Setting up project directory: $PROJECT_DIR"
          mkdir -p "$PROJECT_DIR"
          cd "$PROJECT_DIR"

          echo $(pwd)
          
          # Update repository
          echo "ğŸ”„ Updating repository..."
          git fetch --all
          git reset --hard origin/main
          git clean -fd

          echo "ğŸ“¦ Installing dependencies..."
          npm ci

          echo "ğŸ—ï¸ Building project..."
          npm run build